<!DOCTYPE html>
<html>
<head>
    <title>Batch File Transfer Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-area { 
            border: 2px dashed #ccc; 
            padding: 40px; 
            margin: 20px 0; 
            text-align: center;
            min-height: 200px;
        }
        .test-area.dragover { 
            border-color: #007bff; 
            background-color: #f0f8ff; 
        }
        .log { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Batch File Transfer Test</h1>
    <p>This page tests the batch file transfer functionality by simulating the DeviceTile drop behavior.</p>
    
    <div class="test-area" id="dropArea">
        <h3>Drop Multiple Files Here</h3>
        <p>Drag and drop multiple files to test batch file intent creation</p>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        const dropArea = document.getElementById('dropArea');
        const log = document.getElementById('log');
        
        function addLog(message) {
            log.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            log.scrollTop = log.scrollHeight;
        }
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });
        
        dropArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            addLog(`Files dropped: ${files.length}`);
            
            if (files.length === 0) {
                addLog('No files detected');
                return;
            }
            
            if (files.length === 1) {
                addLog('Single file detected - would create file_handoff intent');
                addLog(`File: ${files[0].name} (${files[0].size} bytes, ${files[0].type})`);
                return;
            }
            
            // Multiple files - test batch intent creation
            addLog(`Multiple files detected: ${files.length} files`);
            
            try {
                const batchId = `batch_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                
                addLog(`Creating batch intent with ID: ${batchId}`);
                addLog(`Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
                
                // Process all files (simulate DeviceTile behavior)
                const processedFiles = await Promise.all(
                    files.map(async (file, index) => {
                        const arrayBuffer = await file.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        return {
                            id: `file_${index}_${Date.now()}`,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: Array.from(uint8Array),
                        };
                    })
                );
                
                const intent = {
                    intent_type: 'batch_file_handoff',
                    payload: {
                        files: {
                            batchId,
                            totalFiles: files.length,
                            totalSize,
                            files: processedFiles,
                        },
                    },
                    target_device: 'test-device',
                    source_device: 'test-source',
                    auto_open: true,
                    timestamp: Date.now(),
                };
                
                addLog('✅ Batch intent created successfully');
                addLog(`Intent type: ${intent.intent_type}`);
                addLog(`Batch ID: ${intent.payload.files.batchId}`);
                addLog(`Total files: ${intent.payload.files.totalFiles}`);
                addLog(`Files processed: ${intent.payload.files.files.length}`);
                
                // Log file details
                intent.payload.files.files.forEach((file, index) => {
                    addLog(`  File ${index + 1}: ${file.name} (${file.size} bytes, ${file.type})`);
                });
                
                // Simulate JSON serialization (what would be sent over WebSocket)
                const jsonSize = JSON.stringify(intent).length;
                addLog(`JSON payload size: ${(jsonSize / 1024).toFixed(2)} KB`);
                
                if (jsonSize > 1024 * 1024) { // 1MB
                    addLog('⚠️ WARNING: Payload is very large, may cause WebSocket issues');
                }
                
            } catch (error) {
                addLog(`❌ Error creating batch intent: ${error.message}`);
            }
        });
        
        addLog('Test page loaded. Ready to test batch file transfers.');
    </script>
</body>
</html>